{
  "rules": {
    "users": {
      // Allow authenticated users to read public profile data for leaderboard and circles
      ".read": "auth != null",
      "$uid": {
        ".write": "auth != null && auth.uid == $uid",
        "profile": {
          // Allow reading public profile data for all authenticated users (needed for circles, leaderboard, etc.)
          ".read": "auth != null",
          ".validate": "newData.hasChildren(['displayName', 'email', 'createdAt'])"
        },
        "habits": {
          "$habitId": {
            ".validate": "newData.hasChildren(['name', 'icon', 'color', 'frequency', 'createdAt'])"
          }
        },
        "checkins": {
          "$date": {
            ".validate": "true"
          }
        },
        "stats": {
          "$habitId": {
            ".validate": "true"
          }
        },
        "follows": {
          "following": {
            ".write": "auth != null && auth.uid == $uid"
          },
          "followers": {
            // Allow authenticated users to add themselves to followers list
            ".write": "auth != null && newData.child(auth.uid).exists() === true || newData.child(auth.uid).exists() === false"
          }
        },
        "circles": {
          // Allow reading circle memberships (needed for private circle member lists)
          // Only contains circleId, joinedAt, and habitId/targetId - no sensitive data
          ".read": "auth != null",
          // Users can write their own circle memberships
          ".write": "auth != null && auth.uid == $uid",
          "$circleId": {
            ".validate": "newData.hasChildren(['joinedAt']) && (newData.child('habitId').exists() || newData.child('targetId').exists())"
          }
        },
        "targets": {
          // Users can read and write their own targets
          ".read": "auth != null && auth.uid == $uid",
          ".write": "auth != null && auth.uid == $uid",
          "$targetId": {
            ".validate": "newData.hasChildren(['title', 'icon', 'color', 'windowType', 'createdAt', 'updatedAt'])"
          }
        },
        "targetInstances": {
          // Users can read and write their own target instances
          ".read": "auth != null && auth.uid == $uid",
          ".write": "auth != null && auth.uid == $uid",
          "$instanceId": {
            ".validate": "newData.hasChildren(['targetId', 'windowKey', 'windowStart', 'windowEnd', 'status', 'createdAt'])"
          }
        },
        "pushSubscriptions": {
          // Users can read and write their own push subscriptions
          ".read": "auth != null && auth.uid == $uid",
          ".write": "auth != null && auth.uid == $uid",
          "$deviceId": {
            ".validate": "newData.hasChildren(['enabled', 'subscription', 'userAgent', 'createdAt', 'updatedAt'])"
          }
        }
      }
    },
    "circles": {
      // Anyone can read circles (for discovery)
      ".read": "auth != null",
      // Authenticated users can create circles
      ".write": "auth != null",
      "$circleId": {
        // Validate basic structure
        ".validate": "newData.hasChildren(['name', 'type', 'createdAt', 'createdBy'])",
        // Only creator can update their circle
        ".write": "auth != null && (newData.exists() || data.child('createdBy').val() === auth.uid)",
        "daily": {
          // Anyone can read daily stats
          ".read": "auth != null",
          // No direct writes to daily stats - calculated from check-ins
          ".write": "false",
          "$date": {
            ".validate": "newData.hasChildren(['date', 'completedCount', 'lastUpdated'])"
          }
        }
      }
    }
  }
}
